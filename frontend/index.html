<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Potential Strategy Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .status-bar {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-top: 20px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: #f0f4f8;
            border-radius: 20px;
            font-weight: 500;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-active { background-color: #10b981; }
        .status-inactive { background-color: #ef4444; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .card h3 {
            margin-bottom: 20px;
            color: #374151;
            font-size: 1.3em;
            font-weight: 600;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-success {
            background: linear-gradient(45deg, #10b981, #059669);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(45deg, #ef4444, #dc2626);
            color: white;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f9fafb;
            border-radius: 10px;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #374151;
        }

        .stat-label {
            font-size: 0.9em;
            color: #6b7280;
            margin-top: 5px;
        }

        .market-data {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .symbol-card {
            background: #f9fafb;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .symbol-name {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .symbol-price {
            font-size: 1.5em;
            color: #374151;
            margin-bottom: 10px;
        }

        .signal-indicator {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .signal-buy { background: #dcfce7; color: #166534; }
        .signal-sell { background: #fee2e2; color: #991b1b; }
        .signal-none { background: #f3f4f6; color: #6b7280; }

        .trades-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .trades-table th,
        .trades-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .trades-table th {
            background: #f9fafb;
            font-weight: 600;
        }

        .profit { color: #10b981; }
        .loss { color: #ef4444; }

        .full-width {
            grid-column: 1 / -1;
        }

        .chart-container {
            height: 400px;
            margin-top: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .settings-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 5px;
            font-weight: 500;
            color: #374151;
        }

        .form-group input,
        .form-group select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .logs-container {
            max-height: 300px;
            overflow-y: auto;
            background: #f9fafb;
            border-radius: 8px;
            padding: 15px;
        }

        .log-item {
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
            font-family: monospace;
            font-size: 0.9em;
        }

        .log-timestamp {
            color: #6b7280;
        }

        .log-event {
            font-weight: bold;
            margin: 0 10px;
        }

        .log-signal { color: #059669; }
        .log-trade { color: #2563eb; }
        .log-error { color: #dc2626; }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üí∞ Financial Potential Strategy</h1>
            <p>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö MOEX</p>
            
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-indicator" id="trading-indicator"></div>
                    <span id="trading-status">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                </div>
                <div class="status-item">
                    <span>üìä –°–∏–º–≤–æ–ª—ã: SBER, GAZP, LKOH, VTBR</span>
                </div>
                <div class="status-item">
                    <span id="last-update">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: --:--</span>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="card">
            <h3>üéÆ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤–ª–µ–π</h3>
            <div class="controls">
                <button class="btn btn-success" onclick="startTrading()">
                    ‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ—Ä–≥–æ–≤–ª—é
                </button>
                <button class="btn btn-danger" onclick="stopTrading()">
                    ‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–æ—Ä–≥–æ–≤–ª—é
                </button>
                <button class="btn btn-secondary" onclick="resetAccount()">
                    üîÑ –°–±—Ä–æ—Å–∏—Ç—å —Å—á–µ—Ç
                </button>
                <button class="btn btn-primary" onclick="refreshData()">
                    üîÉ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                </button>
            </div>
        </div>

        <!-- Dashboard -->
        <div class="dashboard">
            <!-- Account Statistics -->
            <div class="card">
                <h3>üí≥ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å—á–µ—Ç–∞</h3>
                <div class="stats-grid" id="account-stats">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
            </div>

            <!-- Market Data -->
            <div class="card">
                <h3>üìà –†—ã–Ω–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h3>
                <div class="market-data" id="market-data">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
            </div>

            <!-- Recent Trades -->
            <div class="card full-width">
                <h3>üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–¥–µ–ª–∫–∏</h3>
                <div id="trades-container">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
            </div>

            <!-- Strategy Settings -->
            <div class="card full-width">
                <h3>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏</h3>
                <div>
                    <label for="symbol-select">–í—ã–±–µ—Ä–∏—Ç–µ —Å–∏–º–≤–æ–ª:</label>
                    <select id="symbol-select" onchange="loadSettings()">
                        <option value="SBER">SBER</option>
                        <option value="GAZP">GAZP</option>
                        <option value="LKOH">LKOH</option>
                        <option value="VTBR">VTBR</option>
                    </select>
                </div>
                
                <div id="settings-form" class="settings-form">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫...</div>
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="saveSettings()">
                        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                    </button>
                </div>
            </div>

            <!-- Logs -->
            <div class="card full-width">
                <h3>üìú –õ–æ–≥–∏ —Å–æ–±—ã—Ç–∏–π</h3>
                <div class="logs-container" id="logs-container">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE = window.location.origin.includes('localhost') ? 'http://localhost:8000' : '';
        
        // Global state
        let currentSymbol = 'SBER';
        let currentSettings = {};
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboard();
            setInterval(loadDashboard, 30000); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        });

        // API calls
        async function apiCall(endpoint, options = {}) {
            try {
                console.log(`üåê API Call: ${endpoint}`, options);
                
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                console.log(`üì° Response status: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`‚ùå API Error Response:`, errorText);
                    
                    let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    try {
                        const errorJson = JSON.parse(errorText);
                        if (errorJson.detail) {
                            errorMessage += ` - ${errorJson.detail}`;
                        }
                    } catch (e) {
                        // –ù–µ JSON –æ—Ç–≤–µ—Ç
                        if (errorText) {
                            errorMessage += ` - ${errorText.substring(0, 100)}`;
                        }
                    }
                    
                    throw new Error(errorMessage);
                }
                
                const result = await response.json();
                console.log(`‚úÖ API Success:`, result);
                return result;
                
            } catch (error) {
                console.error('üí• API Call failed:', error);
                showNotification(`–û—à–∏–±–∫–∞ API: ${error.message}`, 'error');
                throw error;
            }
        }

        // Load dashboard data
        async function loadDashboard() {
            try {
                await Promise.all([
                    loadTradingStatus(),
                    loadAccountStats(),
                    loadMarketData(),
                    loadTrades(),
                    loadLogs()
                ]);
                
                document.getElementById('last-update').textContent = 
                    `–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${new Date().toLocaleTimeString()}`;
                    
            } catch (error) {
                console.error('Dashboard load error:', error);
            }
        }

        // Trading status
        async function loadTradingStatus() {
            try {
                const status = await apiCall('/api/trading/status');
                const indicator = document.getElementById('trading-indicator');
                const statusText = document.getElementById('trading-status');
                const startButton = document.querySelector('.btn-success');
                const stopButton = document.querySelector('.btn-danger');
                
                if (status.active) {
                    indicator.className = 'status-indicator status-active';
                    statusText.textContent = '–¢–æ—Ä–≥–æ–≤–ª—è –∞–∫—Ç–∏–≤–Ω–∞';
                    startButton.disabled = true;
                    startButton.style.opacity = '0.5';
                    stopButton.disabled = false;
                    stopButton.style.opacity = '1';
                } else {
                    indicator.className = 'status-indicator status-inactive';
                    statusText.textContent = '–¢–æ—Ä–≥–æ–≤–ª—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞';
                    startButton.disabled = false;
                    startButton.style.opacity = '1';
                    stopButton.disabled = true;
                    stopButton.style.opacity = '0.5';
                }
            } catch (error) {
                console.error('Status load error:', error);
            }
        }

        // Account statistics
        async function loadAccountStats() {
            try {
                const stats = await apiCall('/account/statistics');
                const container = document.getElementById('account-stats');
                
                if (stats.summary) {
                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∫–∞–∂–¥–æ–º—É —Å–∏–º–≤–æ–ª—É –æ—Ç–¥–µ–ª—å–Ω–æ
                    let html = '';
                    
                    // –°–≤–æ–¥–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                    html += `
                        <div class="stat-item" style="grid-column: 1 / -1; background: linear-gradient(45deg, #667eea, #764ba2); color: white; font-weight: bold;">
                            <div class="stat-value">${stats.summary.total_balance.toLocaleString('ru-RU')} ‚ÇΩ</div>
                            <div class="stat-label">–û–±—â–∏–π –±–∞–ª–∞–Ω—Å –≤—Å–µ—Ö —Å—á–µ—Ç–æ–≤</div>
                        </div>
                        <div class="stat-item" style="grid-column: 1 / -1; background: #f8f9fa;">
                            <div class="stat-value ${stats.summary.total_return >= 0 ? 'profit' : 'loss'}">
                                ${stats.summary.total_return.toFixed(2)}%
                            </div>
                            <div class="stat-label">–û–±—â–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å –ø–æ—Ä—Ç—Ñ–µ–ª—è</div>
                        </div>
                    `;
                    
                    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞–∂–¥–æ–º—É —Å–∏–º–≤–æ–ª—É
                    for (const [symbol, symbolStats] of Object.entries(stats.accounts)) {
                        const account = symbolStats.account;
                        const trading = symbolStats.trading;
                        
                        html += `
                            <div style="grid-column: 1 / -1; margin: 15px 0 10px 0; font-weight: bold; color: #374151; border-bottom: 2px solid #e5e7eb; padding-bottom: 5px;">
                                ${symbol} - –û—Ç–¥–µ–ª—å–Ω—ã–π —Å—á–µ—Ç
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${account.current_balance.toLocaleString('ru-RU')} ‚ÇΩ</div>
                                <div class="stat-label">–ë–∞–ª–∞–Ω—Å ${symbol}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value ${account.total_return >= 0 ? 'profit' : 'loss'}">
                                    ${account.total_return.toFixed(2)}%
                                </div>
                                <div class="stat-label">–î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å ${symbol}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${account.current_drawdown.toFixed(2)}%</div>
                                <div class="stat-label">–ü—Ä–æ—Å–∞–¥–∫–∞ ${symbol}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${trading.total_trades}</div>
                                <div class="stat-label">–°–¥–µ–ª–æ–∫ ${symbol}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${trading.win_rate.toFixed(1)}%</div>
                                <div class="stat-label">–ü—Ä–∏–±—ã–ª—å–Ω—ã—Ö ${symbol}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${trading.open_positions}</div>
                                <div class="stat-label">–û—Ç–∫—Ä—ã—Ç—ã—Ö ${symbol}</div>
                            </div>
                        `;
                    }
                    
                    container.innerHTML = html;
                } else {
                    // Fallback –¥–ª—è —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞
                    container.innerHTML = `
                        <div class="stat-item">
                            <div class="stat-value">${stats.account.current_balance.toLocaleString('ru-RU')} ‚ÇΩ</div>
                            <div class="stat-label">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value ${stats.account.total_return >= 0 ? 'profit' : 'loss'}">
                                ${stats.account.total_return.toFixed(2)}%
                            </div>
                            <div class="stat-label">–î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${stats.account.current_drawdown.toFixed(2)}%</div>
                            <div class="stat-label">–ü—Ä–æ—Å–∞–¥–∫–∞</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${stats.trading.total_trades}</div>
                            <div class="stat-label">–í—Å–µ–≥–æ —Å–¥–µ–ª–æ–∫</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${stats.trading.win_rate.toFixed(1)}%</div>
                            <div class="stat-label">–ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∏–±—ã–ª—å–Ω—ã—Ö</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${stats.trading.open_positions}</div>
                            <div class="stat-label">–û—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π</div>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('account-stats').innerHTML = 
                    '<div class="loading">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</div>';
            }
        }

        // Market data
        async function loadMarketData() {
            try {
                const marketData = await apiCall('/market-data');
                const container = document.getElementById('market-data');
                
                let html = '';
                for (const [symbol, data] of Object.entries(marketData)) {
                    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å–∏–≥–Ω–∞–ª –¥–ª—è —Å–∏–º–≤–æ–ª–∞
                    let signalClass = 'signal-none';
                    let signalText = '–ù–µ—Ç —Å–∏–≥–Ω–∞–ª–∞';
                    
                    try {
                        const signal = await apiCall(`/signals/${symbol}`);
                        if (signal.direction === 'BUY') {
                            signalClass = 'signal-buy';
                            signalText = `BUY (${(signal.confidence * 100).toFixed(0)}%)`;
                        } else if (signal.direction === 'SELL') {
                            signalClass = 'signal-sell';
                            signalText = `SELL (${(signal.confidence * 100).toFixed(0)}%)`;
                        }
                    } catch (e) {
                        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∏–≥–Ω–∞–ª–∞
                    }
                    
                    html += `
                        <div class="symbol-card">
                            <div class="symbol-name">${symbol}</div>
                            <div class="symbol-price">
                                ${data.current_price ? data.current_price.toFixed(2) + ' ‚ÇΩ' : 'N/A'}
                            </div>
                            <div class="signal-indicator ${signalClass}">
                                ${signalText}
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML = html;
            } catch (error) {
                document.getElementById('market-data').innerHTML = 
                    '<div class="loading">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä—ã–Ω–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</div>';
            }
        }

        // Trades history
        async function loadTrades() {
            try {
                const trades = await apiCall('/trades/history?limit=10');
                const container = document.getElementById('trades-container');
                
                if (trades.length === 0) {
                    container.innerHTML = '<div class="loading">–°–¥–µ–ª–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
                    return;
                }
                
                let html = `
                    <table class="trades-table">
                        <thead>
                            <tr>
                                <th>–í—Ä–µ–º—è</th>
                                <th>–°–∏–º–≤–æ–ª</th>
                                <th>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th>
                                <th>–¶–µ–Ω–∞ –≤—Ö–æ–¥–∞</th>
                                <th>–¶–µ–Ω–∞ –≤—ã—Ö–æ–¥–∞</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>P&L</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                trades.forEach(trade => {
                    const createdAt = new Date(trade.created_at).toLocaleString('ru-RU');
                    const profitClass = trade.profit_loss > 0 ? 'profit' : trade.profit_loss < 0 ? 'loss' : '';
                    
                    html += `
                        <tr>
                            <td>${createdAt}</td>
                            <td>${trade.symbol}</td>
                            <td>${trade.direction}</td>
                            <td>${trade.entry_price.toFixed(4)}</td>
                            <td>${trade.exit_price ? trade.exit_price.toFixed(4) : '-'}</td>
                            <td>${trade.status}</td>
                            <td class="${profitClass}">
                                ${trade.profit_loss ? trade.profit_loss.toFixed(2) + ' ‚ÇΩ' : '-'}
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
                
            } catch (error) {
                document.getElementById('trades-container').innerHTML = 
                    '<div class="loading">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–¥–µ–ª–æ–∫</div>';
            }
        }

        // Load strategy settings
        async function loadSettings() {
            const symbol = document.getElementById('symbol-select').value;
            currentSymbol = symbol;
            
            try {
                const settings = await apiCall(`/settings/${symbol}`);
                currentSettings = settings;
                
                const form = document.getElementById('settings-form');
                form.innerHTML = `
                    <div class="form-group">
                        <label>ATR –ø–µ—Ä–∏–æ–¥</label>
                        <input type="number" id="atr_period" value="${settings.atr_period}" min="1" max="100">
                    </div>
                    <div class="form-group">
                        <label>RSI –ø–µ—Ä–∏–æ–¥</label>
                        <input type="number" id="rsi_period" value="${settings.rsi_period}" min="1" max="100">
                    </div>
                    <div class="form-group">
                        <label>EMA –ø–µ—Ä–∏–æ–¥</label>
                        <input type="number" id="ema_period" value="${settings.ema_period}" min="1" max="200">
                    </div>
                    <div class="form-group">
                        <label>–†–∏—Å–∫ –Ω–∞ —Å–¥–µ–ª–∫—É (%)</label>
                        <input type="number" id="risk_percent" value="${settings.risk_percent}" min="0.1" max="10" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>–ë–∞–∑–æ–≤—ã–π –ª–æ—Ç</label>
                        <input type="number" id="base_lot" value="${settings.base_lot}" min="0.01" max="10" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Stop Loss (ATR)</label>
                        <input type="number" id="stop_loss_atr" value="${settings.stop_loss_atr}" min="0.5" max="10" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Take Profit (ATR)</label>
                        <input type="number" id="take_profit_atr" value="${settings.take_profit_atr}" min="0.5" max="20" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>–ü–æ—Ä–æ–≥ RSI –¥–ª—è –ø–æ–∫—É–ø–∫–∏</label>
                        <input type="number" id="buy_rsi_threshold" value="${settings.buy_rsi_threshold}" min="10" max="90">
                    </div>
                    <div class="form-group">
                        <label>–ü–æ—Ä–æ–≥ RSI –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏</label>
                        <input type="number" id="sell_rsi_threshold" value="${settings.sell_rsi_threshold}" min="10" max="90">
                    </div>
                    <div class="form-group">
                        <label>–†–µ–∂–∏–º —Ç–æ—Ä–≥–æ–≤–ª–∏</label>
                        <select id="mode">
                            <option value="LIMIT" ${settings.mode === 'LIMIT' ? 'selected' : ''}>–õ–∏–º–∏—Ç–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞</option>
                            <option value="BREAKOUT" ${settings.mode === 'BREAKOUT' ? 'selected' : ''}>–ü—Ä–æ–±–æ–π–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>–ú–∞–∫—Å. –ø—Ä–æ—Å–∞–¥–∫–∞ (%)</label>
                        <input type="number" id="max_drawdown_percent" value="${settings.max_drawdown_percent}" min="5" max="50">
                    </div>
                    <div class="form-group">
                        <label>–§–∏–ª—å—Ç—Ä –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏</label>
                        <select id="use_volatility_filter">
                            <option value="true" ${settings.use_volatility_filter ? 'selected' : ''}>–í–∫–ª—é—á–µ–Ω</option>
                            <option value="false" ${!settings.use_volatility_filter ? 'selected' : ''}>–í—ã–∫–ª—é—á–µ–Ω</option>
                        </select>
                    </div>
                `;
                
            } catch (error) {
                document.getElementById('settings-form').innerHTML = 
                    '<div class="loading">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫</div>';
            }
        }

        // Save settings
        async function saveSettings() {
            try {
                // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã
                const formData = {
                    symbol: currentSymbol,
                    atr_period: parseInt(document.getElementById('atr_period').value),
                    rsi_period: parseInt(document.getElementById('rsi_period').value),
                    ema_period: parseInt(document.getElementById('ema_period').value),
                    threshold_level: currentSettings.threshold_level || 0.4,
                    level_radius_factor: currentSettings.level_radius_factor || 4.5,
                    min_potential_strength: currentSettings.min_potential_strength || 0.6,
                    risk_percent: parseFloat(document.getElementById('risk_percent').value),
                    dynamic_lot: currentSettings.dynamic_lot !== undefined ? currentSettings.dynamic_lot : true,
                    base_lot: parseFloat(document.getElementById('base_lot').value),
                    min_lot: currentSettings.min_lot || 0.01,
                    max_drawdown_percent: parseFloat(document.getElementById('max_drawdown_percent').value),
                    reduce_risk_on_drawdown: currentSettings.reduce_risk_on_drawdown !== undefined ? currentSettings.reduce_risk_on_drawdown : true,
                    drawdown_risk_reduction: currentSettings.drawdown_risk_reduction || 0.5,
                    stop_loss_atr: parseFloat(document.getElementById('stop_loss_atr').value),
                    take_profit_atr: parseFloat(document.getElementById('take_profit_atr').value),
                    enable_ladder: currentSettings.enable_ladder !== undefined ? currentSettings.enable_ladder : false,
                    ladder_count: currentSettings.ladder_count || 2,
                    ladder_step_atr: currentSettings.ladder_step_atr || 0.4,
                    buy_rsi_threshold: parseFloat(document.getElementById('buy_rsi_threshold').value),
                    sell_rsi_threshold: parseFloat(document.getElementById('sell_rsi_threshold').value),
                    buy_threshold_multiplier: currentSettings.buy_threshold_multiplier || 1.0,
                    sell_threshold_multiplier: currentSettings.sell_threshold_multiplier || 1.3,
                    use_volatility_filter: document.getElementById('use_volatility_filter').value === 'true',
                    max_atr_multiplier: currentSettings.max_atr_multiplier || 2.2,
                    use_volume_filter: currentSettings.use_volume_filter !== undefined ? currentSettings.use_volume_filter : true,
                    min_volume_ratio: currentSettings.min_volume_ratio || 1.2,
                    mode: document.getElementById('mode').value
                };
                
                console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è', currentSymbol, ':', formData);
                
                const response = await apiCall(`/settings/${currentSymbol}`, {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });
                
                console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response);
                
                showNotification(`–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è ${currentSymbol} —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!`, 'success');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º currentSettings
                currentSettings = response;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
                showNotification(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–ª—è ${currentSymbol}`, 'error');
            }
        }

        // Load logs
        async function loadLogs() {
            try {
                const logs = await apiCall('/logs?limit=20');
                const container = document.getElementById('logs-container');
                
                if (logs.length === 0) {
                    container.innerHTML = '<div class="loading">–õ–æ–≥–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
                    return;
                }
                
                let html = '';
                logs.forEach(log => {
                    const timestamp = new Date(log.timestamp).toLocaleString('ru-RU');
                    const eventClass = log.event_type.toLowerCase().includes('signal') ? 'log-signal' :
                                     log.event_type.toLowerCase().includes('trade') ? 'log-trade' :
                                     log.event_type.toLowerCase().includes('error') ? 'log-error' : '';
                    
                    html += `
                        <div class="log-item">
                            <span class="log-timestamp">${timestamp}</span>
                            <span class="log-event ${eventClass}">[${log.event_type}]</span>
                            <span>${log.symbol ? `${log.symbol}: ` : ''}${log.message}</span>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                
            } catch (error) {
                document.getElementById('logs-container').innerHTML = 
                    '<div class="loading">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤</div>';
            }
        }

        // Trading controls
        let tradingOperationInProgress = false;

        async function startTrading() {
            if (tradingOperationInProgress) return;
            
            const button = document.querySelector('.btn-success');
            try {
                tradingOperationInProgress = true;
                button.disabled = true;
                button.textContent = '‚è≥ –ó–∞–ø—É—Å–∫...';
                
                await apiCall('/api/trading/start', { method: 'POST' });
                showNotification('–¢–æ—Ä–≥–æ–≤–ª—è –∑–∞–ø—É—â–µ–Ω–∞!', 'success');
                await loadTradingStatus();
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ç–æ—Ä–≥–æ–≤–ª–∏', 'error');
            } finally {
                tradingOperationInProgress = false;
                button.disabled = false;
                button.textContent = '‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ—Ä–≥–æ–≤–ª—é';
            }
        }

        async function stopTrading() {
            if (tradingOperationInProgress) return;
            
            const button = document.querySelector('.btn-danger');
            try {
                tradingOperationInProgress = true;
                button.disabled = true;
                button.textContent = '‚è≥ –û—Å—Ç–∞–Ω–æ–≤–∫–∞...';
                
                await apiCall('/api/trading/stop', { method: 'POST' });
                showNotification('–¢–æ—Ä–≥–æ–≤–ª—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!', 'success');
                await loadTradingStatus();
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç–æ—Ä–≥–æ–≤–ª–∏', 'error');
            } finally {
                tradingOperationInProgress = false;
                button.disabled = false;
                button.textContent = '‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–æ—Ä–≥–æ–≤–ª—é';
            }
        }

        async function resetAllAccounts() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –í–°–ï –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ —Å—á–µ—Ç–∞? –í—Å–µ —Å–¥–µ–ª–∫–∏ –±—É–¥—É—Ç –∑–∞–∫—Ä—ã—Ç—ã.')) {
                try {
                    await apiCall('/api/account/reset', { method: 'POST' });
                    showNotification('–í—Å–µ —Å—á–µ—Ç–∞ —Å–±—Ä–æ—à–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!', 'success');
                    await loadDashboard();
                } catch (error) {
                    showNotification('–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ —Å—á–µ—Ç–æ–≤', 'error');
                }
            }
        }

        async function resetSymbolAccount(symbol) {
            if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å —Å—á–µ—Ç –¥–ª—è ${symbol}? –í—Å–µ —Å–¥–µ–ª–∫–∏ –ø–æ —ç—Ç–æ–º—É –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É –±—É–¥—É—Ç –∑–∞–∫—Ä—ã—Ç—ã.`)) {
                try {
                    await apiCall(`/api/account/${symbol}/reset`, { method: 'POST' });
                    showNotification(`–°—á–µ—Ç ${symbol} —Å–±—Ä–æ—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!`, 'success');
                    await loadDashboard();
                } catch (error) {
                    showNotification(`–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ —Å—á–µ—Ç–∞ ${symbol}`, 'error');
                }
            }
        }

        async function refreshData() {
            showNotification('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...', 'info');
            await loadDashboard();
            showNotification('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!', 'success');
        }

        // Notifications
        function showNotification(message, type = 'info') {
            // –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: bold;
                z-index: 1000;
                animation: slideIn 0.3s ease;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        // Initialize settings on page load
        setTimeout(() => {
            loadSettings();
        }, 1000);
    </script>

    <style>
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    </style>
</body>
</html>
