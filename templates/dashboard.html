<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–≤—É—â–∏–π –∫–æ—Ç—ë–Ω–æ–∫ üê± –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
</head>
<body>
    <div class="container">
        <!-- –®–∞–ø–∫–∞ -->
        <header>
            <h1>üê± –†–µ–≤—É—â–∏–π –∫–æ—Ç—ë–Ω–æ–∫ - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h1>
        </header>

        <!-- –ë–ª–æ–∫: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –º–µ—Å—è—Ü -->
        <section class="month-stats">
            <div class="section-header">
                <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ {{ month_name }}</h2>
                <div class="month-selector">
                    <label for="month-select">–í—ã–±—Ä–∞—Ç—å –º–µ—Å—è—Ü:</label>
                    <select id="month-select" onchange="changeMonth(this.value)">
                        {% for m in months_list %}
                        <option value="{{ m.year }}-{{ m.month }}" 
                                {% if m.year == year and m.month == month %}selected{% endif %}>
                            {{ m.label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="stats-cards">
                <div class="stat-card">
                    <div class="stat-value">{{ monthly_stats_all.total_trades }}</div>
                    <div class="stat-label">–í—Å–µ–≥–æ —Å–¥–µ–ª–æ–∫</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ monthly_stats_all.profitable }}</div>
                    <div class="stat-label">–ü—Ä–∏–±—ã–ª—å–Ω—ã—Ö</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ monthly_stats_all.unprofitable }}</div>
                    <div class="stat-label">–£–±—ã—Ç–æ—á–Ω—ã—Ö</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ "%.2f"|format(monthly_stats_all.winrate) }}%</div>
                    <div class="stat-label">–í–∏–Ω—Ä–µ–π—Ç</div>
                </div>
                <div class="stat-card {% if monthly_stats_all.total_profit > 0 %}positive{% else %}negative{% endif %}">
                    <div class="stat-value">
                        {% if monthly_stats_all.total_profit > 0 %}+{% endif %}{{ "%.2f"|format(monthly_stats_all.total_profit) }}%
                    </div>
                    <div class="stat-label">–û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å</div>
                </div>
            </div>
        </section>

        <!-- –ë–ª–æ–∫: –û—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏ -->
        {% if open_positions %}
        <section class="open-positions">
            <h2>üü¢ –û—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏</h2>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>–ê–∫—Ü–∏—è</th>
                            <th>–¢–∏–ø</th>
                            <th>–¶–µ–Ω–∞ –≤—Ö–æ–¥–∞</th>
                            <th>–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞</th>
                            <th>–ü—Ä–∏–±—ã–ª—å</th>
                            <th>–î–∞—Ç–∞ –≤—Ö–æ–¥–∞</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pos in open_positions %}
                        <tr class="{% if pos.position_type == 'LONG' %}position-long{% else %}position-short{% endif %}">
                            <td>{{ pos.stock_emoji }} {{ pos.ticker }} - {{ pos.stock_name }}</td>
                            <td>
                                {% if pos.position_type == 'LONG' %}
                                    <span class="type-badge long-badge">‚ÜóÔ∏è LONG</span>
                                {% else %}
                                    <span class="type-badge short-badge">‚ÜòÔ∏è SHORT</span>
                                {% endif %}
                            </td>
                            <td>{{ "%.2f"|format(pos.entry_price) }} ‚ÇΩ</td>
                            <td>
                                {% if pos.current_price %}
                                    {{ "%.2f"|format(pos.current_price) }} ‚ÇΩ
                                {% else %}
                                    <span style="color: #999;">‚Äî</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if pos.current_profit is not none %}
                                    <span class="{% if pos.current_profit > 0 %}positive{% else %}negative{% endif %}">
                                        {% if pos.current_profit > 0 %}+{% endif %}{{ "%.2f"|format(pos.current_profit) }}%
                                    </span>
                                {% else %}
                                    <span style="color: #999;">‚Äî</span>
                                {% endif %}
                            </td>
                            <td>{{ pos.entry_time.strftime("%d.%m.%Y %H:%M") }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>
        {% endif %}

        <!-- –ë–ª–æ–∫: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∞–∫—Ü–∏—è–º —Å —Ñ–∏–ª—å—Ç—Ä–æ–º –∏ –≥—Ä–∞—Ñ–∏–∫–æ–º -->
        {% if ticker_stats_all %}
        <section class="ticker-stats">
            <div class="section-header">
                <h2>üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∞–∫—Ü–∏—è–º ({{ ticker_filter_label }})</h2>
                <div class="month-selector">
                    <label for="ticker-month-select">–§–∏–ª—å—Ç—Ä –ø–æ –º–µ—Å—è—Ü—É:</label>
                    <select id="ticker-month-select" onchange="changeTickerFilter(this.value)">
                        <option value="all" {% if not ticker_year %}selected{% endif %}>–∑–∞ –≤—Å—ë –≤—Ä–µ–º—è</option>
                        {% for m in months_list %}
                        <option value="{{ m.year }}-{{ m.month }}" 
                                {% if ticker_year == m.year and ticker_month == m.month %}selected{% endif %}>
                            {{ m.label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <!-- –ì—Ä–∞—Ñ–∏–∫ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–æ–π –ø—Ä–∏–±—ã–ª–∏ -->
            <div class="chart-container">
                <canvas id="profitChart"></canvas>
            </div>
            
            <!-- –¢–∞–±–ª–∏—Ü–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>–ê–∫—Ü–∏—è</th>
                            <th>–°–¥–µ–ª–æ–∫</th>
                            <th>–í–∏–Ω—Ä–µ–π—Ç</th>
                            <th>–û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stat in ticker_stats_all %}
                        <tr>
                            <td>{{ stat.stock_emoji }} {{ stat.ticker }} - {{ stat.stock_name }}</td>
                            <td>{{ stat.total_trades }}</td>
                            <td>{{ "%.2f"|format(stat.winrate) }}%</td>
                            <td class="{% if stat.total_profit > 0 %}positive{% else %}negative{% endif %}">
                                {% if stat.total_profit > 0 %}+{% endif %}{{ "%.2f"|format(stat.total_profit) }}%
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>
        {% endif %}

        <!-- –ë–ª–æ–∫: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ -->
        <section class="additional-stats">
            <h2>üíé –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ (–∑–∞ –≤—Å—ë –≤—Ä–µ–º—è)</h2>
            <div class="additional-cards">
                {% if best_trade %}
                <a href="/top-trades?type=best" class="card-link">
                    <div class="additional-card clickable">
                        <div class="card-title">üèÜ –õ—É—á—à–∞—è —Å–¥–µ–ª–∫–∞</div>
                        <div class="card-content">
                            <div class="card-main">{{ best_trade.stock_emoji }} {{ best_trade.ticker }}</div>
                            <div class="type-badge {% if best_trade.position_type == 'LONG' %}long-badge{% else %}short-badge{% endif %}">
                                {% if best_trade.position_type == 'LONG' %}‚ÜóÔ∏è LONG{% else %}‚ÜòÔ∏è SHORT{% endif %}
                            </div>
                            <div class="card-profit positive">+{{ "%.2f"|format(best_trade.profit_percent) }}%</div>
                            <div class="card-date">{{ best_trade.exit_time.strftime("%d.%m.%Y") }}</div>
                        </div>
                        <div class="card-hint">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —Ç–æ–ø-10 ‚Üí</div>
                    </div>
                </a>
                {% endif %}

                {% if worst_trade %}
                <a href="/top-trades?type=worst" class="card-link">
                    <div class="additional-card clickable">
                        <div class="card-title">üìâ –•—É–¥—à–∞—è —Å–¥–µ–ª–∫–∞</div>
                        <div class="card-content">
                            <div class="card-main">{{ worst_trade.stock_emoji }} {{ worst_trade.ticker }}</div>
                            <div class="type-badge {% if worst_trade.position_type == 'LONG' %}long-badge{% else %}short-badge{% endif %}">
                                {% if worst_trade.position_type == 'LONG' %}‚ÜóÔ∏è LONG{% else %}‚ÜòÔ∏è SHORT{% endif %}
                            </div>
                            <div class="card-profit negative">{{ "%.2f"|format(worst_trade.profit_percent) }}%</div>
                            <div class="card-date">{{ worst_trade.exit_time.strftime("%d.%m.%Y") }}</div>
                        </div>
                        <div class="card-hint">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —Ç–æ–ø-10 ‚Üí</div>
                    </div>
                </a>
                {% endif %}

                <div class="additional-card">
                    <div class="card-title">‚è±Ô∏è –°—Ä–µ–¥–Ω—è—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</div>
                    <div class="card-content">
                        <div class="card-main-large">{{ avg_duration_str }}</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- –ë–ª–æ–∫: –ü–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å–¥–µ–ª–æ–∫ —Å —Ñ–∏–ª—å—Ç—Ä–æ–º –ø–æ —Ç–∏–ø—É -->
        {% if closed_positions %}
        <section class="trades-feed">
            <div class="section-header">
                <h2>üìú –ü–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å–¥–µ–ª–æ–∫</h2>
                <div class="feed-filters">
                    <div class="filter-group">
                        <label for="feed-type-select">–¢–∏–ø:</label>
                        <select id="feed-type-select" onchange="changeFeedType()">
                            <option value="all" {% if feed_type == 'all' %}selected{% endif %}>–í—Å–µ</option>
                            <option value="LONG" {% if feed_type == 'LONG' %}selected{% endif %}>LONG</option>
                            <option value="SHORT" {% if feed_type == 'SHORT' %}selected{% endif %}>SHORT</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>–î–∞—Ç–∞ –∑–∞–∫—Ä—ã—Ç–∏—è</th>
                            <th>–ê–∫—Ü–∏—è</th>
                            <th>–¢–∏–ø</th>
                            <th>–ü—Ä–∏–±—ã–ª—å</th>
                            <th>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pos in closed_positions %}
                        <tr class="{% if pos.position_type == 'LONG' %}position-long-subtle{% else %}position-short-subtle{% endif %}">
                            <td>{{ pos.exit_time.strftime("%d.%m.%Y %H:%M") }}</td>
                            <td>{{ pos.stock_emoji }} {{ pos.ticker }} - {{ pos.stock_name }}</td>
                            <td>
                                {% if pos.position_type == 'LONG' %}
                                    <span class="type-badge long-badge">‚ÜóÔ∏è LONG</span>
                                {% else %}
                                    <span class="type-badge short-badge">‚ÜòÔ∏è SHORT</span>
                                {% endif %}
                            </td>
                            <td class="{% if pos.profit_percent > 0 %}positive{% else %}negative{% endif %}">
                                {% if pos.profit_percent > 0 %}+{% endif %}{{ "%.2f"|format(pos.profit_percent) }}%
                            </td>
                            <td>{{ pos.duration_str }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>
        {% else %}
        <section class="trades-feed">
            <div class="section-header">
                <h2>üìú –ü–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å–¥–µ–ª–æ–∫</h2>
                <div class="feed-filters">
                    <div class="filter-group">
                        <label for="feed-type-select">–¢–∏–ø:</label>
                        <select id="feed-type-select" onchange="changeFeedType()">
                            <option value="all" selected>–í—Å–µ</option>
                            <option value="LONG">LONG</option>
                            <option value="SHORT">SHORT</option>
                        </select>
                    </div>
                </div>
            </div>
            <p class="no-data">–ù–µ—Ç —Å–¥–µ–ª–æ–∫ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞</p>
        </section>
        {% endif %}

        <footer>
            <p>¬© 2025 –†–µ–≤—É—â–∏–π –∫–æ—Ç—ë–Ω–æ–∫ üê± | –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</p>
        </footer>
    </div>

    <script>
        // –î–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ –∏–∑ backend
        const chartDataRaw = {{ chart_data_json | safe }};
        
        // –¶–≤–µ—Ç–∞ –¥–ª—è –∫–∞–∂–¥–æ–π –∞–∫—Ü–∏–∏
        const stockColors = {
            'SBER': 'rgb(34, 139, 34)',      // –ó–µ–ª–µ–Ω—ã–π
            'GAZP': 'rgb(70, 130, 180)',     // –°–∏–Ω–∏–π
            'LKOH': 'rgb(220, 20, 60)',      // –ö—Ä–∞—Å–Ω—ã–π
            'VTBR': 'rgb(255, 140, 0)',      // –û—Ä–∞–Ω–∂–µ–≤—ã–π
            'HEAD': 'rgb(138, 43, 226)'      // –§–∏–æ–ª–µ—Ç–æ–≤—ã–π
        };
        
        // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º datasets –¥–ª—è Chart.js
        const datasets = Object.keys(chartDataRaw).map(ticker => {
            const stockData = chartDataRaw[ticker];
            
            return {
                label: stockData.label,
                data: stockData.data,
                borderColor: stockColors[ticker] || 'rgb(128, 128, 128)',
                backgroundColor: stockColors[ticker] ? stockColors[ticker].replace('rgb', 'rgba').replace(')', ', 0.1)') : 'rgba(128, 128, 128, 0.1)',
                borderWidth: 2,
                tension: 0.1,
                pointRadius: 3,
                pointHoverRadius: 5
            };
        });
        
        // –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
        const ctx = document.getElementById('profitChart').getContext('2d');
        const profitChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    title: {
                        display: true,
                        text: '–ì—Ä–∞—Ñ–∏–∫ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–æ–π –ø—Ä–∏–±—ã–ª–∏ –ø–æ –∞–∫—Ü–∏—è–º',
                        font: {
                            size: 18,
                            weight: 'bold'
                        },
                        padding: {
                            top: 10,
                            bottom: 20
                        }
                    },
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 15,
                            font: {
                                size: 13
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toFixed(2) + '%';
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day',
                            displayFormats: {
                                day: 'dd.MM.yyyy'
                            }
                        },
                        title: {
                            display: true,
                            text: '–î–∞—Ç–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å–¥–µ–ª–∫–∏',
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: '–ù–∞–∫–æ–ø–ª–µ–Ω–Ω–∞—è –ø—Ä–∏–±—ã–ª—å (%)',
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            callback: function(value) {
                                return value.toFixed(0) + '%';
                            }
                        }
                    }
                }
            }
        });

        function changeMonth(value) {
            const [year, month] = value.split('-');
            const url = new URL(window.location);
            url.searchParams.set('year', year);
            url.searchParams.set('month', month);
            window.location.href = url.toString();
        }

        function changeTickerFilter(value) {
            const url = new URL(window.location);
            if (value === 'all') {
                url.searchParams.delete('ticker_year');
                url.searchParams.delete('ticker_month');
            } else {
                const [year, month] = value.split('-');
                url.searchParams.set('ticker_year', year);
                url.searchParams.set('ticker_month', month);
            }
            window.location.href = url.toString();
        }

        function changeFeedType() {
            const typeSelect = document.getElementById('feed-type-select');
            const url = new URL(window.location);
            
            // –§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É
            if (typeSelect.value === 'all') {
                url.searchParams.delete('feed_type');
            } else {
                url.searchParams.set('feed_type', typeSelect.value);
            }
            
            window.location.href = url.toString();
        }
    </script>
</body>
</html>
